name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump strategy"
        required: false
        type: choice
        default: auto
        options:
          - auto
          - major
          - minor
          - patch
      dry_run:
        description: "Compute only, do not tag/release"
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Bump From PR Labels
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;
            let bump = "patch";
            let source = "default";
            let prNumber = "";

            try {
              const pulls = await github.request("GET /repos/{owner}/{repo}/commits/{commit_sha}/pulls", {
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: sha,
              });

              if (pulls.data.length > 0) {
                const pr = pulls.data[0];
                prNumber = String(pr.number);
                const labels = (pr.labels || []).map((l) => l.name);

                if (labels.includes("release/major") || labels.includes("decision/major")) {
                  bump = "major";
                  source = "pr-label";
                } else if (labels.includes("release/minor") || labels.includes("type/task")) {
                  bump = "minor";
                  source = "pr-label";
                } else if (labels.includes("release/patch") || labels.includes("type/bug") || labels.includes("type/chore") || labels.includes("type/docs")) {
                  bump = "patch";
                  source = "pr-label";
                }
              }
            } catch (err) {
              core.warning(`Could not resolve PR labels for ${sha}: ${err.message}`);
            }

            core.setOutput("bump", bump);
            core.setOutput("source", source);
            core.setOutput("pr_number", prNumber);

      - name: Resolve Bump Strategy
        id: resolve
        run: |
          INPUT_BUMP="${{ github.event.inputs.bump || 'auto' }}"
          DETECTED="${{ steps.detect.outputs.bump }}"

          if [ "${INPUT_BUMP}" = "auto" ]; then
            BUMP="${DETECTED}"
          else
            BUMP="${INPUT_BUMP}"
          fi

          echo "bump=${BUMP}" >> "${GITHUB_OUTPUT}"

      - name: Compute Next Version
        id: version
        run: |
          set -euo pipefail

          latest_tag="$(git tag -l 'v*.*.*' --sort=-v:refname | head -n1)"
          if [ -z "${latest_tag}" ]; then
            latest_tag="v0.0.0"
          fi

          version="${latest_tag#v}"
          IFS='.' read -r major minor patch <<< "${version}"

          bump="${{ steps.resolve.outputs.bump }}"
          case "${bump}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
            *)
              echo "Unsupported bump: ${bump}" >&2
              exit 1
              ;;
          esac

          next_tag="v${major}.${minor}.${patch}"
          if git rev-parse "${next_tag}" >/dev/null 2>&1; then
            echo "exists=true" >> "${GITHUB_OUTPUT}"
          else
            echo "exists=false" >> "${GITHUB_OUTPUT}"
          fi

          echo "previous_tag=${latest_tag}" >> "${GITHUB_OUTPUT}"
          echo "next_tag=${next_tag}" >> "${GITHUB_OUTPUT}"

      - name: Configure Git User
        if: steps.version.outputs.exists == 'false' && (github.event.inputs.dry_run || 'false') != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create Git Tag
        if: steps.version.outputs.exists == 'false' && (github.event.inputs.dry_run || 'false') != 'true'
        run: |
          tag="${{ steps.version.outputs.next_tag }}"
          git tag -a "${tag}" -m "release: ${tag}"
          git push origin "${tag}"

      - name: Publish GitHub Release
        if: steps.version.outputs.exists == 'false' && (github.event.inputs.dry_run || 'false') != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.next_tag }}" \
            --repo "${{ github.repository }}" \
            --title "${{ steps.version.outputs.next_tag }}" \
            --generate-notes

      - name: Release Summary
        run: |
          echo "bump=${{ steps.resolve.outputs.bump }}"
          echo "source=${{ steps.detect.outputs.source }}"
          echo "pr=${{ steps.detect.outputs.pr_number }}"
          echo "previous=${{ steps.version.outputs.previous_tag }}"
          echo "next=${{ steps.version.outputs.next_tag }}"
          echo "exists=${{ steps.version.outputs.exists }}"
